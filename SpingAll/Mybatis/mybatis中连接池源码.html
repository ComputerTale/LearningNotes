<html>
<head>
  <title>mybatis中连接池源码</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601535 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="687"/>
<h1>mybatis中连接池源码</h1>

<div>
<span><div><span style="font-size: 16px;">连接池定义部分</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">//</font></div><div><font style="font-size: 12pt;">// Source code recreated from a .class file by IntelliJ IDEA</font></div><div><font style="font-size: 12pt;">// (powered by Fernflower decompiler)</font></div><div><font style="font-size: 12pt;">//</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">package org.apache.ibatis.datasource.pooled;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">import java.util.ArrayList;</font></div><div><font style="font-size: 12pt;">import java.util.List;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">public class PoolState {</font></div><div><font style="font-size: 12pt;">    protected PooledDataSource dataSource;</font></div><div><font style="font-size: 12pt;">    protected final List&lt;PooledConnection&gt; idleConnections = new ArrayList();</font></div><div><font style="font-size: 12pt;">    protected final List&lt;PooledConnection&gt; activeConnections = new ArrayList();</font></div><div><font style="font-size: 12pt;">    protected long requestCount = 0L;</font></div><div><font style="font-size: 12pt;">    protected long accumulatedRequestTime = 0L;</font></div><div><font style="font-size: 12pt;">    protected long accumulatedCheckoutTime = 0L;</font></div><div><font style="font-size: 12pt;">    protected long claimedOverdueConnectionCount = 0L;</font></div><div><font style="font-size: 12pt;">    protected long accumulatedCheckoutTimeOfOverdueConnections = 0L;</font></div><div><font style="font-size: 12pt;">    protected long accumulatedWaitTime = 0L;</font></div><div><font style="font-size: 12pt;">    protected long hadToWaitCount = 0L;</font></div><div><font style="font-size: 12pt;">    protected long badConnectionCount = 0L;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PoolState(PooledDataSource dataSource) {</font></div><div><font style="font-size: 12pt;">        this.dataSource = dataSource;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getRequestCount() {</font></div><div><font style="font-size: 12pt;">        return this.requestCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getAverageRequestTime() {</font></div><div><font style="font-size: 12pt;">        return this.requestCount == 0L ? 0L : this.accumulatedRequestTime / this.requestCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getAverageWaitTime() {</font></div><div><font style="font-size: 12pt;">        return this.hadToWaitCount == 0L ? 0L : this.accumulatedWaitTime / this.hadToWaitCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getHadToWaitCount() {</font></div><div><font style="font-size: 12pt;">        return this.hadToWaitCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getBadConnectionCount() {</font></div><div><font style="font-size: 12pt;">        return this.badConnectionCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getClaimedOverdueConnectionCount() {</font></div><div><font style="font-size: 12pt;">        return this.claimedOverdueConnectionCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getAverageOverdueCheckoutTime() {</font></div><div><font style="font-size: 12pt;">        return this.claimedOverdueConnectionCount == 0L ? 0L : this.accumulatedCheckoutTimeOfOverdueConnections / this.claimedOverdueConnectionCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized long getAverageCheckoutTime() {</font></div><div><font style="font-size: 12pt;">        return this.requestCount == 0L ? 0L : this.accumulatedCheckoutTime / this.requestCount;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized int getIdleConnectionCount() {</font></div><div><font style="font-size: 12pt;">        return this.idleConnections.size();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized int getActiveConnectionCount() {</font></div><div><font style="font-size: 12pt;">        return this.activeConnections.size();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public synchronized String toString() {</font></div><div><font style="font-size: 12pt;">        StringBuilder builder = new StringBuilder();</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n===CONFINGURATION==============================================&quot;);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n jdbcDriver                     &quot;).append(this.dataSource.getDriver());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n jdbcUrl                        &quot;).append(this.dataSource.getUrl());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n jdbcUsername                   &quot;).append(this.dataSource.getUsername());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n jdbcPassword                   &quot;).append(this.dataSource.getPassword() == null ? &quot;NULL&quot; : &quot;************&quot;);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n poolMaxActiveConnections       &quot;).append(this.dataSource.poolMaximumActiveConnections);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n poolMaxIdleConnections         &quot;).append(this.dataSource.poolMaximumIdleConnections);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n poolMaxCheckoutTime            &quot;).append(this.dataSource.poolMaximumCheckoutTime);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n poolTimeToWait                 &quot;).append(this.dataSource.poolTimeToWait);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n poolPingEnabled                &quot;).append(this.dataSource.poolPingEnabled);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n poolPingQuery                  &quot;).append(this.dataSource.poolPingQuery);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n poolPingConnectionsNotUsedFor  &quot;).append(this.dataSource.poolPingConnectionsNotUsedFor);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n ---STATUS-----------------------------------------------------&quot;);</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n activeConnections              &quot;).append(this.getActiveConnectionCount());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n idleConnections                &quot;).append(this.getIdleConnectionCount());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n requestCount                   &quot;).append(this.getRequestCount());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n averageRequestTime             &quot;).append(this.getAverageRequestTime());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n averageCheckoutTime            &quot;).append(this.getAverageCheckoutTime());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n claimedOverdue                 &quot;).append(this.getClaimedOverdueConnectionCount());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n averageOverdueCheckoutTime     &quot;).append(this.getAverageOverdueCheckoutTime());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n hadToWait                      &quot;).append(this.getHadToWaitCount());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n averageWaitTime                &quot;).append(this.getAverageWaitTime());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n badConnectionCount             &quot;).append(this.getBadConnectionCount());</font></div><div><font style="font-size: 12pt;">        builder.append(&quot;\n===============================================================&quot;);</font></div><div><font style="font-size: 12pt;">        return builder.toString();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 16px;">逻辑处理部分</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">//</font></div><div><font style="font-size: 12pt;">// Source code recreated from a .class file by IntelliJ IDEA</font></div><div><font style="font-size: 12pt;">// (powered by Fernflower decompiler)</font></div><div><font style="font-size: 12pt;">//</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">package org.apache.ibatis.datasource.pooled;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">import java.io.PrintWriter;</font></div><div><font style="font-size: 12pt;">import java.lang.reflect.InvocationHandler;</font></div><div><font style="font-size: 12pt;">import java.lang.reflect.Proxy;</font></div><div><font style="font-size: 12pt;">import java.sql.Connection;</font></div><div><font style="font-size: 12pt;">import java.sql.DriverManager;</font></div><div><font style="font-size: 12pt;">import java.sql.SQLException;</font></div><div><font style="font-size: 12pt;">import java.sql.Statement;</font></div><div><font style="font-size: 12pt;">import java.util.Properties;</font></div><div><font style="font-size: 12pt;">import java.util.logging.Logger;</font></div><div><font style="font-size: 12pt;">import javax.sql.DataSource;</font></div><div><font style="font-size: 12pt;">import org.apache.ibatis.datasource.unpooled.UnpooledDataSource;</font></div><div><font style="font-size: 12pt;">import org.apache.ibatis.logging.Log;</font></div><div><font style="font-size: 12pt;">import org.apache.ibatis.logging.LogFactory;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">public class PooledDataSource implements DataSource {</font></div><div><font style="font-size: 12pt;">    private static final Log log = LogFactory.getLog(PooledDataSource.class);</font></div><div><font style="font-size: 12pt;">    private final PoolState state = new PoolState(this);</font></div><div><font style="font-size: 12pt;">    private final UnpooledDataSource dataSource;</font></div><div><font style="font-size: 12pt;">    protected int poolMaximumActiveConnections = 10;</font></div><div><font style="font-size: 12pt;">    protected int poolMaximumIdleConnections = 5;</font></div><div><font style="font-size: 12pt;">    protected int poolMaximumCheckoutTime = 20000;</font></div><div><font style="font-size: 12pt;">    protected int poolTimeToWait = 20000;</font></div><div><font style="font-size: 12pt;">    protected int poolMaximumLocalBadConnectionTolerance = 3;</font></div><div><font style="font-size: 12pt;">    protected String poolPingQuery = &quot;NO PING QUERY SET&quot;;</font></div><div><font style="font-size: 12pt;">    protected boolean poolPingEnabled;</font></div><div><font style="font-size: 12pt;">    protected int poolPingConnectionsNotUsedFor;</font></div><div><font style="font-size: 12pt;">    private int expectedConnectionTypeCode;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PooledDataSource() {</font></div><div><font style="font-size: 12pt;">        this.dataSource = new UnpooledDataSource();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PooledDataSource(UnpooledDataSource dataSource) {</font></div><div><font style="font-size: 12pt;">        this.dataSource = dataSource;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PooledDataSource(String driver, String url, String username, String password) {</font></div><div><font style="font-size: 12pt;">        this.dataSource = new UnpooledDataSource(driver, url, username, password);</font></div><div><font style="font-size: 12pt;">        this.expectedConnectionTypeCode = this.assembleConnectionTypeCode(this.dataSource.getUrl(), this.dataSource.getUsername(), this.dataSource.getPassword());</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PooledDataSource(String driver, String url, Properties driverProperties) {</font></div><div><font style="font-size: 12pt;">        this.dataSource = new UnpooledDataSource(driver, url, driverProperties);</font></div><div><font style="font-size: 12pt;">        this.expectedConnectionTypeCode = this.assembleConnectionTypeCode(this.dataSource.getUrl(), this.dataSource.getUsername(), this.dataSource.getPassword());</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PooledDataSource(ClassLoader driverClassLoader, String driver, String url, String username, String password) {</font></div><div><font style="font-size: 12pt;">        this.dataSource = new UnpooledDataSource(driverClassLoader, driver, url, username, password);</font></div><div><font style="font-size: 12pt;">        this.expectedConnectionTypeCode = this.assembleConnectionTypeCode(this.dataSource.getUrl(), this.dataSource.getUsername(), this.dataSource.getPassword());</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PooledDataSource(ClassLoader driverClassLoader, String driver, String url, Properties driverProperties) {</font></div><div><font style="font-size: 12pt;">        this.dataSource = new UnpooledDataSource(driverClassLoader, driver, url, driverProperties);</font></div><div><font style="font-size: 12pt;">        this.expectedConnectionTypeCode = this.assembleConnectionTypeCode(this.dataSource.getUrl(), this.dataSource.getUsername(), this.dataSource.getPassword());</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public Connection getConnection() throws SQLException {</font></div><div><font style="font-size: 12pt;">        return this.popConnection(this.dataSource.getUsername(), this.dataSource.getPassword()).getProxyConnection();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public Connection getConnection(String username, String password) throws SQLException {</font></div><div><font style="font-size: 12pt;">        return this.popConnection(username, password).getProxyConnection();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setLoginTimeout(int loginTimeout) {</font></div><div><font style="font-size: 12pt;">        DriverManager.setLoginTimeout(loginTimeout);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public int getLoginTimeout() {</font></div><div><font style="font-size: 12pt;">        return DriverManager.getLoginTimeout();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setLogWriter(PrintWriter logWriter) {</font></div><div><font style="font-size: 12pt;">        DriverManager.setLogWriter(logWriter);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PrintWriter getLogWriter() {</font></div><div><font style="font-size: 12pt;">        return DriverManager.getLogWriter();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setDriver(String driver) {</font></div><div><font style="font-size: 12pt;">        this.dataSource.setDriver(driver);</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setUrl(String url) {</font></div><div><font style="font-size: 12pt;">        this.dataSource.setUrl(url);</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setUsername(String username) {</font></div><div><font style="font-size: 12pt;">        this.dataSource.setUsername(username);</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPassword(String password) {</font></div><div><font style="font-size: 12pt;">        this.dataSource.setPassword(password);</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setDefaultAutoCommit(boolean defaultAutoCommit) {</font></div><div><font style="font-size: 12pt;">        this.dataSource.setAutoCommit(defaultAutoCommit);</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setDefaultTransactionIsolationLevel(Integer defaultTransactionIsolationLevel) {</font></div><div><font style="font-size: 12pt;">        this.dataSource.setDefaultTransactionIsolationLevel(defaultTransactionIsolationLevel);</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setDriverProperties(Properties driverProps) {</font></div><div><font style="font-size: 12pt;">        this.dataSource.setDriverProperties(driverProps);</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolMaximumActiveConnections(int poolMaximumActiveConnections) {</font></div><div><font style="font-size: 12pt;">        this.poolMaximumActiveConnections = poolMaximumActiveConnections;</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolMaximumIdleConnections(int poolMaximumIdleConnections) {</font></div><div><font style="font-size: 12pt;">        this.poolMaximumIdleConnections = poolMaximumIdleConnections;</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolMaximumLocalBadConnectionTolerance(int poolMaximumLocalBadConnectionTolerance) {</font></div><div><font style="font-size: 12pt;">        this.poolMaximumLocalBadConnectionTolerance = poolMaximumLocalBadConnectionTolerance;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolMaximumCheckoutTime(int poolMaximumCheckoutTime) {</font></div><div><font style="font-size: 12pt;">        this.poolMaximumCheckoutTime = poolMaximumCheckoutTime;</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolTimeToWait(int poolTimeToWait) {</font></div><div><font style="font-size: 12pt;">        this.poolTimeToWait = poolTimeToWait;</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolPingQuery(String poolPingQuery) {</font></div><div><font style="font-size: 12pt;">        this.poolPingQuery = poolPingQuery;</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolPingEnabled(boolean poolPingEnabled) {</font></div><div><font style="font-size: 12pt;">        this.poolPingEnabled = poolPingEnabled;</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void setPoolPingConnectionsNotUsedFor(int milliseconds) {</font></div><div><font style="font-size: 12pt;">        this.poolPingConnectionsNotUsedFor = milliseconds;</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public String getDriver() {</font></div><div><font style="font-size: 12pt;">        return this.dataSource.getDriver();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public String getUrl() {</font></div><div><font style="font-size: 12pt;">        return this.dataSource.getUrl();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public String getUsername() {</font></div><div><font style="font-size: 12pt;">        return this.dataSource.getUsername();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public String getPassword() {</font></div><div><font style="font-size: 12pt;">        return this.dataSource.getPassword();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public boolean isAutoCommit() {</font></div><div><font style="font-size: 12pt;">        return this.dataSource.isAutoCommit();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public Integer getDefaultTransactionIsolationLevel() {</font></div><div><font style="font-size: 12pt;">        return this.dataSource.getDefaultTransactionIsolationLevel();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public Properties getDriverProperties() {</font></div><div><font style="font-size: 12pt;">        return this.dataSource.getDriverProperties();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public int getPoolMaximumActiveConnections() {</font></div><div><font style="font-size: 12pt;">        return this.poolMaximumActiveConnections;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public int getPoolMaximumIdleConnections() {</font></div><div><font style="font-size: 12pt;">        return this.poolMaximumIdleConnections;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public int getPoolMaximumLocalBadConnectionTolerance() {</font></div><div><font style="font-size: 12pt;">        return this.poolMaximumLocalBadConnectionTolerance;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public int getPoolMaximumCheckoutTime() {</font></div><div><font style="font-size: 12pt;">        return this.poolMaximumCheckoutTime;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public int getPoolTimeToWait() {</font></div><div><font style="font-size: 12pt;">        return this.poolTimeToWait;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public String getPoolPingQuery() {</font></div><div><font style="font-size: 12pt;">        return this.poolPingQuery;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public boolean isPoolPingEnabled() {</font></div><div><font style="font-size: 12pt;">        return this.poolPingEnabled;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public int getPoolPingConnectionsNotUsedFor() {</font></div><div><font style="font-size: 12pt;">        return this.poolPingConnectionsNotUsedFor;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public void forceCloseAll() {</font></div><div><font style="font-size: 12pt;">        synchronized(this.state) {</font></div><div><font style="font-size: 12pt;">            this.expectedConnectionTypeCode = this.assembleConnectionTypeCode(this.dataSource.getUrl(), this.dataSource.getUsername(), this.dataSource.getPassword());</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">            int i;</font></div><div><font style="font-size: 12pt;">            PooledConnection conn;</font></div><div><font style="font-size: 12pt;">            Connection realConn;</font></div><div><font style="font-size: 12pt;">            for(i = this.state.activeConnections.size(); i &gt; 0; --i) {</font></div><div><font style="font-size: 12pt;">                try {</font></div><div><font style="font-size: 12pt;">                    conn = (PooledConnection)this.state.activeConnections.remove(i - 1);</font></div><div><font style="font-size: 12pt;">                    conn.invalidate();</font></div><div><font style="font-size: 12pt;">                    realConn = conn.getRealConnection();</font></div><div><font style="font-size: 12pt;">                    if (!realConn.getAutoCommit()) {</font></div><div><font style="font-size: 12pt;">                        realConn.rollback();</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                    realConn.close();</font></div><div><font style="font-size: 12pt;">                } catch (Exception var7) {</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">            for(i = this.state.idleConnections.size(); i &gt; 0; --i) {</font></div><div><font style="font-size: 12pt;">                try {</font></div><div><font style="font-size: 12pt;">                    conn = (PooledConnection)this.state.idleConnections.remove(i - 1);</font></div><div><font style="font-size: 12pt;">                    conn.invalidate();</font></div><div><font style="font-size: 12pt;">                    realConn = conn.getRealConnection();</font></div><div><font style="font-size: 12pt;">                    if (!realConn.getAutoCommit()) {</font></div><div><font style="font-size: 12pt;">                        realConn.rollback();</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                    realConn.close();</font></div><div><font style="font-size: 12pt;">                } catch (Exception var6) {</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">            log.debug(&quot;PooledDataSource forcefully closed/removed all connections.&quot;);</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public PoolState getPoolState() {</font></div><div><font style="font-size: 12pt;">        return this.state;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    private int assembleConnectionTypeCode(String url, String username, String password) {</font></div><div><font style="font-size: 12pt;">        return (&quot;&quot; + url + username + password).hashCode();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><span>    </span><span>    </span><br/></span></div><div><font style="font-size: 12pt;">    protected void pushConnection(PooledConnection conn) throws SQLException {</font></div><div><font style="font-size: 12pt;">        synchronized(this.state) {</font></div><div><font style="font-size: 12pt;">            this.state.activeConnections.remove(conn);</font></div><div><font style="font-size: 12pt;">            if (conn.isValid()) {</font></div><div><font style="font-size: 12pt;">                PoolState var10000;</font></div><div><font style="font-size: 12pt;">                if (this.state.idleConnections.size() &lt; this.poolMaximumIdleConnections &amp;&amp; conn.getConnectionTypeCode() == this.expectedConnectionTypeCode) {</font></div><div><font style="font-size: 12pt;">                    var10000 = this.state;</font></div><div><font style="font-size: 12pt;">                    var10000.accumulatedCheckoutTime += conn.getCheckoutTime();</font></div><div><font style="font-size: 12pt;">                    if (!conn.getRealConnection().getAutoCommit()) {</font></div><div><font style="font-size: 12pt;">                        conn.getRealConnection().rollback();</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                    PooledConnection newConn = new PooledConnection(conn.getRealConnection(), this);</font></div><div><font style="font-size: 12pt;">                    this.state.idleConnections.add(newConn);</font></div><div><font style="font-size: 12pt;">                    newConn.setCreatedTimestamp(conn.getCreatedTimestamp());</font></div><div><font style="font-size: 12pt;">                    newConn.setLastUsedTimestamp(conn.getLastUsedTimestamp());</font></div><div><font style="font-size: 12pt;">                    conn.invalidate();</font></div><div><font style="font-size: 12pt;">                    if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                        log.debug(&quot;Returned connection &quot; + newConn.getRealHashCode() + &quot; to pool.&quot;);</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                    this.state.notifyAll();</font></div><div><font style="font-size: 12pt;">                } else {</font></div><div><font style="font-size: 12pt;">                    var10000 = this.state;</font></div><div><font style="font-size: 12pt;">                    var10000.accumulatedCheckoutTime += conn.getCheckoutTime();</font></div><div><font style="font-size: 12pt;">                    if (!conn.getRealConnection().getAutoCommit()) {</font></div><div><font style="font-size: 12pt;">                        conn.getRealConnection().rollback();</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                    conn.getRealConnection().close();</font></div><div><font style="font-size: 12pt;">                    if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                        log.debug(&quot;Closed connection &quot; + conn.getRealHashCode() + &quot;.&quot;);</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                    conn.invalidate();</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;">            } else {</font></div><div><font style="font-size: 12pt;">                if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                    log.debug(&quot;A bad connection (&quot; + conn.getRealHashCode() + &quot;) attempted to return to the pool, discarding connection.&quot;);</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                ++this.state.badConnectionCount;</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="background-color: rgb(255, 250, 165); font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;-evernote-highlight:true;">//获取连接</span></div><div><font style="font-size: 12pt; background-color: rgb(255, 250, 165);-evernote-highlight:true;">    private PooledConnection popConnection(String username, String password) throws SQLException {</font></div><div><font style="font-size: 12pt;">        boolean countedWait = false;</font></div><div><font style="font-size: 12pt;">        PooledConnection conn = null;</font></div><div><font style="font-size: 12pt;">        long t = System.currentTimeMillis();</font></div><div><font style="font-size: 12pt;">        int localBadConnectionCount = 0;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        while(conn == null) {</font></div><div><font style="font-size: 12pt;">            synchronized(this.state) {</font></div><div><font style="font-size: 12pt;">                PoolState var10000;</font></div><div><font style="font-size: 12pt;">                if (!this.state.idleConnections.isEmpty()) {</font></div><div><font style="font-size: 12pt;">//若当前存在空闲连接，则直接获取</font></div><div><font style="font-size: 12pt;">                    conn = (PooledConnection)this.state.idleConnections.remove(0);</font></div><div><font style="font-size: 12pt;">                    if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                        log.debug(&quot;Checked out connection &quot; + conn.getRealHashCode() + &quot; from pool.&quot;);</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;">                } else if (this.state.activeConnections.size() &lt; this.poolMaximumActiveConnections) {</font></div><div><font style="font-size: 12pt;">//若不存在空闲连接，且当前已使用连接数小于连接池最大连接数，则new一个新的连接</font></div><div><font style="font-size: 12pt;">                    conn = new PooledConnection(this.dataSource.getConnection(), this);</font></div><div><font style="font-size: 12pt;">                    if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                        log.debug(&quot;Created connection &quot; + conn.getRealHashCode() + &quot;.&quot;);</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;">                } else {</font></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">//若当前已经达到最大连接数，则判断创建最早的连接是否超过最大连接时长</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">//若超过最大连接时长，则移除该连接，并新建一个连接</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">//若未超过最大连接时长，则等待</span></div><div><font style="font-size: 12pt;">                    PooledConnection oldestActiveConnection = (PooledConnection)this.state.activeConnections.get(0);</font></div><div><font style="font-size: 12pt;">                    long longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</font></div><div><font style="font-size: 12pt;">                    if (longestCheckoutTime &gt; (long)this.poolMaximumCheckoutTime) {</font></div><div><font style="font-size: 12pt;">                        ++this.state.claimedOverdueConnectionCount;</font></div><div><font style="font-size: 12pt;">                        var10000 = this.state;</font></div><div><font style="font-size: 12pt;">                        var10000.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;</font></div><div><font style="font-size: 12pt;">                        var10000 = this.state;</font></div><div><font style="font-size: 12pt;">                        var10000.accumulatedCheckoutTime += longestCheckoutTime;</font></div><div><font style="font-size: 12pt;">                        this.state.activeConnections.remove(oldestActiveConnection);</font></div><div><font style="font-size: 12pt;">                        if (!oldestActiveConnection.getRealConnection().getAutoCommit()) {</font></div><div><font style="font-size: 12pt;">                            try {</font></div><div><font style="font-size: 12pt;">                                oldestActiveConnection.getRealConnection().rollback();</font></div><div><font style="font-size: 12pt;">                            } catch (SQLException var15) {</font></div><div><font style="font-size: 12pt;">                                log.debug(&quot;Bad connection. Could not roll back&quot;);</font></div><div><font style="font-size: 12pt;">                            }</font></div><div><font style="font-size: 12pt;">                        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                        conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this);</font></div><div><font style="font-size: 12pt;">                        conn.setCreatedTimestamp(oldestActiveConnection.getCreatedTimestamp());</font></div><div><font style="font-size: 12pt;">                        conn.setLastUsedTimestamp(oldestActiveConnection.getLastUsedTimestamp());</font></div><div><font style="font-size: 12pt;">                        oldestActiveConnection.invalidate();</font></div><div><font style="font-size: 12pt;">                        if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                            log.debug(&quot;Claimed overdue connection &quot; + conn.getRealHashCode() + &quot;.&quot;);</font></div><div><font style="font-size: 12pt;">                        }</font></div><div><font style="font-size: 12pt;">                    } else {</font></div><div><font style="font-size: 12pt;">                        try {</font></div><div><font style="font-size: 12pt;">                            if (!countedWait) {</font></div><div><font style="font-size: 12pt;">                                ++this.state.hadToWaitCount;</font></div><div><font style="font-size: 12pt;">                                countedWait = true;</font></div><div><font style="font-size: 12pt;">                            }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                            if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                                log.debug(&quot;Waiting as long as &quot; + this.poolTimeToWait + &quot; milliseconds for connection.&quot;);</font></div><div><font style="font-size: 12pt;">                            }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                            long wt = System.currentTimeMillis();</font></div><div><font style="font-size: 12pt;">                            this.state.wait((long)this.poolTimeToWait);</font></div><div><font style="font-size: 12pt;">                            var10000 = this.state;</font></div><div><font style="font-size: 12pt;">                            var10000.accumulatedWaitTime += System.currentTimeMillis() - wt;</font></div><div><font style="font-size: 12pt;">                        } catch (InterruptedException var16) {</font></div><div><font style="font-size: 12pt;">                            break;</font></div><div><font style="font-size: 12pt;">                        }</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                if (conn != null) {</font></div><div><font style="font-size: 12pt;">                    if (conn.isValid()) {</font></div><div><font style="font-size: 12pt;">                        if (!conn.getRealConnection().getAutoCommit()) {</font></div><div><font style="font-size: 12pt;">                            conn.getRealConnection().rollback();</font></div><div><font style="font-size: 12pt;">                        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                        conn.setConnectionTypeCode(this.assembleConnectionTypeCode(this.dataSource.getUrl(), username, password));</font></div><div><font style="font-size: 12pt;">                        conn.setCheckoutTimestamp(System.currentTimeMillis());</font></div><div><font style="font-size: 12pt;">                        conn.setLastUsedTimestamp(System.currentTimeMillis());</font></div><div><font style="font-size: 12pt;">                        this.state.activeConnections.add(conn);</font></div><div><font style="font-size: 12pt;">                        ++this.state.requestCount;</font></div><div><font style="font-size: 12pt;">                        var10000 = this.state;</font></div><div><font style="font-size: 12pt;">                        var10000.accumulatedRequestTime += System.currentTimeMillis() - t;</font></div><div><font style="font-size: 12pt;">                    } else {</font></div><div><font style="font-size: 12pt;">                        if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                            log.debug(&quot;A bad connection (&quot; + conn.getRealHashCode() + &quot;) was returned from the pool, getting another connection.&quot;);</font></div><div><font style="font-size: 12pt;">                        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                        ++this.state.badConnectionCount;</font></div><div><font style="font-size: 12pt;">                        ++localBadConnectionCount;</font></div><div><font style="font-size: 12pt;">                        conn = null;</font></div><div><font style="font-size: 12pt;">                        if (localBadConnectionCount &gt; this.poolMaximumIdleConnections + this.poolMaximumLocalBadConnectionTolerance) {</font></div><div><font style="font-size: 12pt;">                            if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                                log.debug(&quot;PooledDataSource: Could not get a good connection to the database.&quot;);</font></div><div><font style="font-size: 12pt;">                            }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                            throw new SQLException(&quot;PooledDataSource: Could not get a good connection to the database.&quot;);</font></div><div><font style="font-size: 12pt;">                        }</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        if (conn == null) {</font></div><div><font style="font-size: 12pt;">            if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                log.debug(&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;);</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">            throw new SQLException(&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;);</font></div><div><font style="font-size: 12pt;">        } else {</font></div><div><font style="font-size: 12pt;">            return conn;</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    protected boolean pingConnection(PooledConnection conn) {</font></div><div><font style="font-size: 12pt;">        boolean result = true;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        try {</font></div><div><font style="font-size: 12pt;">            result = !conn.getRealConnection().isClosed();</font></div><div><font style="font-size: 12pt;">        } catch (SQLException var11) {</font></div><div><font style="font-size: 12pt;">            if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                log.debug(&quot;Connection &quot; + conn.getRealHashCode() + &quot; is BAD: &quot; + var11.getMessage());</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">            result = false;</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        if (result &amp;&amp; this.poolPingEnabled &amp;&amp; this.poolPingConnectionsNotUsedFor &gt;= 0 &amp;&amp; conn.getTimeElapsedSinceLastUse() &gt; (long)this.poolPingConnectionsNotUsedFor) {</font></div><div><font style="font-size: 12pt;">            try {</font></div><div><font style="font-size: 12pt;">                if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                    log.debug(&quot;Testing connection &quot; + conn.getRealHashCode() + &quot; ...&quot;);</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                Connection realConn = conn.getRealConnection();</font></div><div><font style="font-size: 12pt;">                Statement statement = realConn.createStatement();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                try {</font></div><div><font style="font-size: 12pt;">                    statement.executeQuery(this.poolPingQuery).close();</font></div><div><font style="font-size: 12pt;">                } catch (Throwable var9) {</font></div><div><font style="font-size: 12pt;">                    if (statement != null) {</font></div><div><font style="font-size: 12pt;">                        try {</font></div><div><font style="font-size: 12pt;">                            statement.close();</font></div><div><font style="font-size: 12pt;">                        } catch (Throwable var8) {</font></div><div><font style="font-size: 12pt;">                            var9.addSuppressed(var8);</font></div><div><font style="font-size: 12pt;">                        }</font></div><div><font style="font-size: 12pt;">                    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                    throw var9;</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                if (statement != null) {</font></div><div><font style="font-size: 12pt;">                    statement.close();</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                if (!realConn.getAutoCommit()) {</font></div><div><font style="font-size: 12pt;">                    realConn.rollback();</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                result = true;</font></div><div><font style="font-size: 12pt;">                if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                    log.debug(&quot;Connection &quot; + conn.getRealHashCode() + &quot; is GOOD!&quot;);</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;">            } catch (Exception var10) {</font></div><div><font style="font-size: 12pt;">                log.warn(&quot;Execution of ping query '&quot; + this.poolPingQuery + &quot;' failed: &quot; + var10.getMessage());</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                try {</font></div><div><font style="font-size: 12pt;">                    conn.getRealConnection().close();</font></div><div><font style="font-size: 12pt;">                } catch (Exception var7) {</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">                result = false;</font></div><div><font style="font-size: 12pt;">                if (log.isDebugEnabled()) {</font></div><div><font style="font-size: 12pt;">                    log.debug(&quot;Connection &quot; + conn.getRealHashCode() + &quot; is BAD: &quot; + var10.getMessage());</font></div><div><font style="font-size: 12pt;">                }</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        return result;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public static Connection unwrapConnection(Connection conn) {</font></div><div><font style="font-size: 12pt;">        if (Proxy.isProxyClass(conn.getClass())) {</font></div><div><font style="font-size: 12pt;">            InvocationHandler handler = Proxy.getInvocationHandler(conn);</font></div><div><font style="font-size: 12pt;">            if (handler instanceof PooledConnection) {</font></div><div><font style="font-size: 12pt;">                return ((PooledConnection)handler).getRealConnection();</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        return conn;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    protected void finalize() throws Throwable {</font></div><div><font style="font-size: 12pt;">        this.forceCloseAll();</font></div><div><font style="font-size: 12pt;">        super.finalize();</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public &lt;T&gt; T unwrap(Class&lt;T&gt; iface) throws SQLException {</font></div><div><font style="font-size: 12pt;">        throw new SQLException(this.getClass().getName() + &quot; is not a wrapper.&quot;);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public boolean isWrapperFor(Class&lt;?&gt; iface) {</font></div><div><font style="font-size: 12pt;">        return false;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    public Logger getParentLogger() {</font></div><div><font style="font-size: 12pt;">        return Logger.getLogger(&quot;global&quot;);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><br/></div></span>
</div></body></html> 